//! Graphics utilities for userspace applications
//!
//! Provides bitmap font and rendering helpers for GUI apps running at EL0.
//! All GUI code runs in userspace - this is the shared library for rendering.

/// 8x8 bitmap font data (128 ASCII characters)
/// Scaled 2x to 16x16 when rendered for better readability
pub const FONT_8X8: [[u8; 8]; 128] = [
    // Control characters 0-31 (blank)
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 0
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 1
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 2
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 3
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 4
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 5
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 6
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 7
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 8
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 9
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 10
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 11
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 12
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 13
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 14
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 15
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 16
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 17
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 18
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 19
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 20
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 21
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 22
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 23
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 24
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 25
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 26
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 27
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 28
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 29
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 30
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 31
    // Printable characters (32-127)
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 32 - space
    [0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x00], // 33 - !
    [0x66, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00], // 34 - "
    [0x6C, 0x6C, 0xFE, 0x6C, 0xFE, 0x6C, 0x6C, 0x00], // 35 - #
    [0x18, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x18, 0x00], // 36 - $
    [0x62, 0x66, 0x0C, 0x18, 0x30, 0x66, 0x46, 0x00], // 37 - %
    [0x3C, 0x66, 0x3C, 0x38, 0x67, 0x66, 0x3F, 0x00], // 38 - &
    [0x0C, 0x18, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00], // 39 - '
    [0x0C, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0C, 0x00], // 40 - (
    [0x30, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x30, 0x00], // 41 - )
    [0x00, 0x66, 0x3C, 0xFF, 0x3C, 0x66, 0x00, 0x00], // 42 - *
    [0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00], // 43 - +
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x30], // 44 - ,
    [0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00], // 45 - -
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00], // 46 - .
    [0x00, 0x03, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x00], // 47 - /
    [0x3C, 0x66, 0x6E, 0x76, 0x66, 0x66, 0x3C, 0x00], // 48 - 0
    [0x18, 0x38, 0x18, 0x18, 0x18, 0x18, 0x7E, 0x00], // 49 - 1
    [0x3C, 0x66, 0x06, 0x0C, 0x30, 0x60, 0x7E, 0x00], // 50 - 2
    [0x3C, 0x66, 0x06, 0x1C, 0x06, 0x66, 0x3C, 0x00], // 51 - 3
    [0x0C, 0x1C, 0x3C, 0x6C, 0x7E, 0x0C, 0x0C, 0x00], // 52 - 4
    [0x7E, 0x60, 0x7C, 0x06, 0x06, 0x66, 0x3C, 0x00], // 53 - 5
    [0x3C, 0x66, 0x60, 0x7C, 0x66, 0x66, 0x3C, 0x00], // 54 - 6
    [0x7E, 0x06, 0x0C, 0x18, 0x30, 0x30, 0x30, 0x00], // 55 - 7
    [0x3C, 0x66, 0x66, 0x3C, 0x66, 0x66, 0x3C, 0x00], // 56 - 8
    [0x3C, 0x66, 0x66, 0x3E, 0x06, 0x66, 0x3C, 0x00], // 57 - 9
    [0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00], // 58 - :
    [0x00, 0x18, 0x18, 0x00, 0x18, 0x18, 0x30, 0x00], // 59 - ;
    [0x0C, 0x18, 0x30, 0x60, 0x30, 0x18, 0x0C, 0x00], // 60 - <
    [0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00], // 61 - =
    [0x30, 0x18, 0x0C, 0x06, 0x0C, 0x18, 0x30, 0x00], // 62 - >
    [0x3C, 0x66, 0x06, 0x0C, 0x18, 0x00, 0x18, 0x00], // 63 - ?
    [0x3C, 0x66, 0x6E, 0x6E, 0x60, 0x62, 0x3C, 0x00], // 64 - @
    [0x18, 0x3C, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00], // 65 - A
    [0x7C, 0x66, 0x66, 0x7C, 0x66, 0x66, 0x7C, 0x00], // 66 - B
    [0x3C, 0x66, 0x60, 0x60, 0x60, 0x66, 0x3C, 0x00], // 67 - C
    [0x78, 0x6C, 0x66, 0x66, 0x66, 0x6C, 0x78, 0x00], // 68 - D
    [0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x7E, 0x00], // 69 - E
    [0x7E, 0x60, 0x60, 0x78, 0x60, 0x60, 0x60, 0x00], // 70 - F
    [0x3C, 0x66, 0x60, 0x6E, 0x66, 0x66, 0x3C, 0x00], // 71 - G
    [0x66, 0x66, 0x66, 0x7E, 0x66, 0x66, 0x66, 0x00], // 72 - H
    [0x3C, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00], // 73 - I
    [0x1E, 0x0C, 0x0C, 0x0C, 0x0C, 0x6C, 0x38, 0x00], // 74 - J
    [0x66, 0x6C, 0x78, 0x70, 0x78, 0x6C, 0x66, 0x00], // 75 - K
    [0x60, 0x60, 0x60, 0x60, 0x60, 0x60, 0x7E, 0x00], // 76 - L
    [0x63, 0x77, 0x7F, 0x6B, 0x63, 0x63, 0x63, 0x00], // 77 - M
    [0x66, 0x76, 0x7E, 0x7E, 0x6E, 0x66, 0x66, 0x00], // 78 - N
    [0x3C, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00], // 79 - O
    [0x7C, 0x66, 0x66, 0x7C, 0x60, 0x60, 0x60, 0x00], // 80 - P
    [0x3C, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x0E, 0x00], // 81 - Q
    [0x7C, 0x66, 0x66, 0x7C, 0x78, 0x6C, 0x66, 0x00], // 82 - R
    [0x3C, 0x66, 0x60, 0x3C, 0x06, 0x66, 0x3C, 0x00], // 83 - S
    [0x7E, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00], // 84 - T
    [0x66, 0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x00], // 85 - U
    [0x66, 0x66, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00], // 86 - V
    [0x63, 0x63, 0x63, 0x6B, 0x7F, 0x77, 0x63, 0x00], // 87 - W
    [0x66, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x66, 0x00], // 88 - X
    [0x66, 0x66, 0x66, 0x3C, 0x18, 0x18, 0x18, 0x00], // 89 - Y
    [0x7E, 0x06, 0x0C, 0x18, 0x30, 0x60, 0x7E, 0x00], // 90 - Z
    [0x3C, 0x30, 0x30, 0x30, 0x30, 0x30, 0x3C, 0x00], // 91 - [
    [0x00, 0x60, 0x30, 0x18, 0x0C, 0x06, 0x03, 0x00], // 92 - \
    [0x3C, 0x0C, 0x0C, 0x0C, 0x0C, 0x0C, 0x3C, 0x00], // 93 - ]
    [0x08, 0x1C, 0x36, 0x63, 0x00, 0x00, 0x00, 0x00], // 94 - ^
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFF, 0x00], // 95 - _
    [0x30, 0x18, 0x0C, 0x00, 0x00, 0x00, 0x00, 0x00], // 96 - `
    [0x00, 0x00, 0x3C, 0x06, 0x3E, 0x66, 0x3E, 0x00], // 97 - a
    [0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x7C, 0x00], // 98 - b
    [0x00, 0x00, 0x3C, 0x60, 0x60, 0x60, 0x3C, 0x00], // 99 - c
    [0x06, 0x06, 0x3E, 0x66, 0x66, 0x66, 0x3E, 0x00], // 100 - d
    [0x00, 0x00, 0x3C, 0x66, 0x7E, 0x60, 0x3C, 0x00], // 101 - e
    [0x0E, 0x18, 0x7E, 0x18, 0x18, 0x18, 0x18, 0x00], // 102 - f
    [0x00, 0x00, 0x3E, 0x66, 0x3E, 0x06, 0x7C, 0x00], // 103 - g
    [0x60, 0x60, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00], // 104 - h
    [0x18, 0x00, 0x38, 0x18, 0x18, 0x18, 0x3C, 0x00], // 105 - i
    [0x06, 0x00, 0x06, 0x06, 0x06, 0x66, 0x3C, 0x00], // 106 - j
    [0x60, 0x60, 0x6C, 0x78, 0x78, 0x6C, 0x66, 0x00], // 107 - k
    [0x38, 0x18, 0x18, 0x18, 0x18, 0x18, 0x3C, 0x00], // 108 - l
    [0x00, 0x00, 0x66, 0x7F, 0x7F, 0x6B, 0x63, 0x00], // 109 - m
    [0x00, 0x00, 0x7C, 0x66, 0x66, 0x66, 0x66, 0x00], // 110 - n
    [0x00, 0x00, 0x3C, 0x66, 0x66, 0x66, 0x3C, 0x00], // 111 - o
    [0x00, 0x00, 0x7C, 0x66, 0x7C, 0x60, 0x60, 0x00], // 112 - p
    [0x00, 0x00, 0x3E, 0x66, 0x3E, 0x06, 0x06, 0x00], // 113 - q
    [0x00, 0x00, 0x7C, 0x66, 0x60, 0x60, 0x60, 0x00], // 114 - r
    [0x00, 0x00, 0x3E, 0x60, 0x3C, 0x06, 0x7C, 0x00], // 115 - s
    [0x18, 0x18, 0x7E, 0x18, 0x18, 0x18, 0x0E, 0x00], // 116 - t
    [0x00, 0x00, 0x66, 0x66, 0x66, 0x66, 0x3E, 0x00], // 117 - u
    [0x00, 0x00, 0x66, 0x66, 0x66, 0x3C, 0x18, 0x00], // 118 - v
    [0x00, 0x00, 0x63, 0x6B, 0x7F, 0x7F, 0x36, 0x00], // 119 - w
    [0x00, 0x00, 0x66, 0x3C, 0x18, 0x3C, 0x66, 0x00], // 120 - x
    [0x00, 0x00, 0x66, 0x66, 0x3E, 0x06, 0x7C, 0x00], // 121 - y
    [0x00, 0x00, 0x7E, 0x0C, 0x18, 0x30, 0x7E, 0x00], // 122 - z
    [0x0E, 0x18, 0x30, 0x30, 0x30, 0x18, 0x0E, 0x00], // 123 - {
    [0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x18, 0x00], // 124 - |
    [0x70, 0x18, 0x0C, 0x0C, 0x0C, 0x18, 0x70, 0x00], // 125 - }
    [0x76, 0xDC, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 126 - ~
    [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], // 127
];

/// Draw a single character to a pixel buffer (ARGB format)
///
/// buffer: Target pixel buffer
/// buffer_width: Width of buffer in pixels
/// buffer_height: Height of buffer in pixels
/// x, y: Position to draw character
/// ch: ASCII character to draw
/// color: ARGB color (0xAARRGGBB)
///
/// Characters are scaled 2x (8x8 font -> 16x16 pixels)
pub fn draw_char(buffer: &mut [u32], buffer_width: usize, buffer_height: usize,
                 x: i32, y: i32, ch: u8, color: u32) {
    use crate::print_debug;

    let char_data = if ch < 128 {
        FONT_8X8[ch as usize]
    } else {
        FONT_8X8[0] // Use null character for unknown
    };

    let mut pixels_written = 0;

    // Scale 2x - each pixel in the 8x8 font becomes a 2x2 block
    for (row, &byte) in char_data.iter().enumerate() {
        for col in 0..8 {
            if (byte & (0x80 >> col)) != 0 {
                // Draw 2x2 block for each font pixel
                for dy in 0..2 {
                    for dx in 0..2 {
                        let px = x + (col * 2 + dx) as i32;
                        let py = y + (row * 2 + dy) as i32;
                        if px >= 0 && px < buffer_width as i32 && py >= 0 && py < buffer_height as i32 {
                            let idx = (py as usize * buffer_width) + px as usize;
                            if idx < buffer.len() {
                                buffer[idx] = color;
                                pixels_written += 1;
                            }
                        }
                    }
                }
            }
        }
    }

    // Debug ALL chars to see what's being drawn
    if pixels_written > 0 {
        print_debug("DC:");
        let s = [ch];
        print_debug(core::str::from_utf8(&s).unwrap_or("?"));
        print_debug("=");
        if pixels_written < 10 {
            let s = [b'0' + pixels_written as u8];
            print_debug(core::str::from_utf8(&s).unwrap_or("?"));
        } else if pixels_written < 100 {
            let tens = pixels_written / 10;
            let ones = pixels_written % 10;
            let s = [b'0' + tens as u8, b'0' + ones as u8];
            print_debug(core::str::from_utf8(&s).unwrap_or("?"));
        }
        print_debug(" ");
    }
}

/// Draw text string to a pixel buffer
///
/// buffer: Target pixel buffer
/// buffer_width: Width of buffer in pixels
/// buffer_height: Height of buffer in pixels
/// x, y: Position to start drawing
/// text: UTF-8 text to draw (only ASCII supported for now)
/// color: ARGB color (0xAARRGGBB)
pub fn draw_text(buffer: &mut [u32], buffer_width: usize, buffer_height: usize,
                 x: i32, y: i32, text: &str, color: u32) {
    let mut cur_x = x;
    for ch in text.bytes() {
        if ch == b'\n' {
            return; // Stop at newline
        }
        draw_char(buffer, buffer_width, buffer_height, cur_x, y, ch, color);
        cur_x += 16; // Move to next character (16px wide when scaled 2x)
    }
}
